<html>
<head>
<script>

var ajax = null;
var timeout = null;

if(window.ActiveXObject) {		
	ajax = new ActiveXObject("Microsoft.XMLHTTP");	
}
else if(window.XMLHttpRequest) {		
	ajax = new XMLHttpRequest();	
}

function ajaxLoad(method, URL, data, displayId) {
	ajax.open(method, URL);
	ajax.onreadystatechange = function() {
	 	if(ajax.readyState==4 && ajax.status==200) {
			ajaxCallback(displayId, ajax.responseText);
		}
	}
		
	ajax.send(data);
}

function ajaxCallback(displayId, responseText){
	//ซ่อนภาพ indicator
	document.getElementById('indicator').style.display = 'none';

	var el = document.getElementById(displayId);
 	el.innerHTML = responseText;

	clearTimeout(timeout);
}

function ajaxTimeout() {
	 if(ajax.readyState == 1) {
		ajax.abort(); //สั่งให้ Ajax หยุดทำงาน
		//ซ่อนภาพ indicator
		document.getElementById('indicator').style.display = 'none';
		alert('ไม่มีการตอบสนองจากเซิร์ฟเวอร์ !');	
	 }
	
	clearTimeout(timeout);
}

function ajaxCall() {
	var URL = 
 		"http://localhost/ajaxbook/chap7/timeout_ss.php";
	URL += "?dummy=" + (new Date()).getTime();

	var sleep = document.getElementById('sleep').value;
	URL += "&sleep=" + sleep;

	var data = null;
	ajaxLoad('get', URL, data, 'displayDiv');
	
	//เริ่มจับเวลาทางด้านบราวเซอร์
	var t = document.getElementById('timeout').value * 1000;
	timeout = setTimeout("ajaxTimeout()", t);

	//แสดงภาพ indicator
	document.getElementById('indicator').style.display = 'block';
}
</script>
</head>
<body>
<h3>Ajax Timeout</h3>
<form name="frm">
จับเวลาการตอบสนอง:<input type="text" id="timeout" size="2">วินาที
<br>
หน่วงเวลาที่เซิร์ฟเวอร์:<input type="text" id="sleep" size="2">วินาที
</form>

<button onclick="ajaxCall()">ทดสอบ Ajax Timeout</button>

<!-- อีลีเมนท์ที่ใช้ในการแสดง Indicator -->
<div id="indicator" 
	style="position:absolute; display:none; z-index:1000;
 		background-color:#e1e1e1; padding:3px;">

<img src="indicator.gif" hspace="10" align="absmiddle">
กำลังโหลดข้อมูล...
</div>

<p>
<div id="displayDiv">&nbsp;</div>
</body>
</html>
